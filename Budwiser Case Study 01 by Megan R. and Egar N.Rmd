---
title: "Budwiser Case Study"
author: "Edgar Nunez and Megan Riley"
output: html_document
---

In the document below we explore the given Beer and Brewery data. This includes some analysis of summary statistics followed by a look into the relationship between IBU and ABV and finally some additional exploratory data analysis with an additional data set. 


First you can see the data we load along with the libraries used in this analysis. 

```{r setup, warnings = FALSE, message= FALSE}
#Loading Libraries
library(stringr)
library(tidyverse)
library(ggplot2)
library(GGally)
library(dplyr)
library(ggthemes)
library(class)
library(caret)
library(usmap)


# Read in data from Local Files
BeersData = read_csv("Beers.csv")
BreweriesData = read_csv("Breweries.csv")



```


##Key Question One
###How many breweries are present in each state?

Below you will see the histogram demonstrating how many breweries can be found in each state. You may see a few top states such as Colorado and California, but several other states have a decent presence of breweries. 

```{r warnings = FALSE}
#How Many Breweries in Each State? 
library(tidyverse)
#At the moment the file wont knit without reloading tidyverse here
#Should find a permanent fix for the final rmd presentation.
StatesCount = BreweriesData %>% group_by(State) %>% summarise(n = n())

StatesCount %>% ggplot(aes(x = State, y = n)) + geom_bar(stat="identity") + ggtitle("Number of Breweries per State") + ylab("Count of Breweries")


```


##Key Question Two
###Merge the Beer and Breweries data

Next in order to view the entire picture we merge the Beer data with the Brewery data and clean the variable names so they are later easily referenced. 

The first six and last six entries of the merged data set are also printed below. 

```{r warnings = FALSE, cache=TRUE}
#Merge the Data 
BeerWithBreweries = merge(BeersData,BreweriesData, by.x = "Brewery_id", by.y = "Brew_ID")
colnames(BeerWithBreweries)[colnames(BeerWithBreweries)=="Name.x"] <- "Beer_Name"
colnames(BeerWithBreweries)[colnames(BeerWithBreweries)=="Name.y"] <- "Brewery_Name"

head(BeerWithBreweries, n = 6)
tail(BeerWithBreweries, n = 6)

```

##Key Question Three
###Address the Missing Values in each Column

Next we will address the missing values. First a copy of the data is made so that we can compare the data before and after imputation. 

After initial investigations we know ABV seems to have 

```{r warnings = FALSE}
#Address the Missing Values in Each Column

#Copy Made to compare differences after Imputation
BeersCopy = BeersData

#First the Exploration Graphs and Residuals of a Linear Model
ggplot(BeersCopy, aes(x = ABV, y = IBU)) +
  geom_point () +
  geom_smooth (method='lm') +
  labs (
    title = "ABV and IBU relationship",
    subtitle = "Strong Positive Correlation",
    x = "ABV",
    y = "IBU")
```



```{r warnings = FALSE}

#Linear Model
lmibu = lm(BeersData$IBU ~BeersData$ABV, data = BeersData)

#Demonstrate the Residuals
plot(resid(lmibu), main = "Residuals of a Linear Model of IBU based on ABV", ylab = "Residuals")

#Correlation Test to determine how good a linear model fit is. 
cor.test(BeersData$ABV,BeersData$IBU, method = "pearson")


#Given the above we will move forward with a linear model. 
predicted = predict(lmibu, BeersData[,4])

NaTempIndices = which(is.na(BeersData$IBU))
for(i in NaTempIndices){
  BeersData$IBU[i] = predicted[i]
}

#For the final 62 Missing Values we can impute the median to not lose the values. 

#Determine Medians
MedianIBU <- median(BeersData$IBU, na.rm = TRUE)
MedianABV <- median(BeersData$ABV, na.rm = TRUE) 

#Replace IBU
NAIndicesIBU = which(is.na(BeersData$IBU))
for(i in NAIndicesIBU){
  BeersData$IBU[i] = MedianIBU
}

#ReplaceABV
NAIndicesABV = which(is.na(BeersData$ABV))
for(i in NAIndicesABV){
  BeersData$ABV[i] = MedianABV
}


#We can now see how the distribution changes here. 
BeersCopy %>% ggplot(aes(x = IBU)) + geom_density()
BeersData %>% ggplot(aes(x = IBU)) + geom_density()

#Note that the new data density has a peak above the original data spread and we should remember going forward that the IBU data is artificially inflated 


#In order to ensure our combined data is correct we are re-merging it here
BeerWithBreweries = merge(BeersData,BreweriesData, by.x = "Brewery_id", by.y = "Brew_ID")
colnames(BeerWithBreweries)[colnames(BeerWithBreweries)=="Name.x"] <- "Beer_Name"
colnames(BeerWithBreweries)[colnames(BeerWithBreweries)=="Name.y"] <- "Brewery_Name"


```



##Key Question Four
###Compute the median alcohol content and international bitterness for each state

```{r}
library(ggthemes)

MedianABVState = BeerWithBreweries %>% group_by(State) %>% summarise(MedABV = median(ABV, na.rm = TRUE))

MedianABVState %>% ggplot(aes(x = State, y = MedABV)) + geom_bar(stat = "identity", fill = "light green") +
  ylab("Median ABV") + ggtitle("Median Beer ABV by State") + theme_clean()

MedianIBUState = BeerWithBreweries %>% group_by(State) %>% summarise(MedIBU = median(IBU, na.rm = TRUE))

MedianIBUState %>% ggplot(aes(x = State, y = MedIBU)) + geom_bar(stat = "identity", fill = "light blue")+
  ylab("Median State IBU") + ggtitle("Median Beer IBU by State") + theme_clean()

#Given we imputed a predicted value into 1005 NAs in IBU here is the original data for comparison
OrigCombined = merge(BeersCopy,BreweriesData, by.x = "Brewery_id", by.y = "Brew_ID")
colnames(OrigCombined)[colnames(OrigCombined)=="Name.x"] <- "Beer_Name"
colnames(OrigCombined)[colnames(OrigCombined)=="Name.y"] <- "Brewery_Name"

OrigMedianIBUState = OrigCombined %>% group_by(State) %>% summarise(MedIBU = median(IBU, na.rm = TRUE))

OrigMedianIBUState %>% ggplot(aes(x = State, y = MedIBU)) + geom_bar(stat = "identity", fill = "light blue")+
  ylab("Median State IBU") + ggtitle("Median Beer IBU by State") + theme_clean()




```



##Key Question Five
###Which state has the maximum alcoholic beer? 
###Which state has the most bitter beer? 

```{r warnings = FALSE}
#Which state has the maximum ABV beer. 
ABVMax = which.max(BeerWithBreweries$ABV)
print(BeerWithBreweries[ABVMax,c(2,4,8,10)])

#Which state has the most bitter IBU beer? 
IBUMax = which.max(BeerWithBreweries$IBU)
print(BeerWithBreweries[IBUMax,c(2,5,8,10)])

```

##Key Question Six
###Comment on the summary statistics and distributions of the ABV variable. 

```{r warnings = FALSE, message=FALSE}
#Summary Statistics and Distribution of the ABV variable
BeersData %>% ggplot(aes(x = ABV)) + geom_histogram(stat = "count", fill = "brown") +
  theme_clean() + ggtitle("Distribution of ABV in Beers") + ylab("Frequency of Beers by ABV")
summary(BeersData$ABV)

BeersData %>% ggplot(aes(y = ABV)) + geom_boxplot( fill = "brown") +
  theme_clean() + ggtitle("Boxplot of ABV in Beers") 




```

###Key Question Seven
##Is there an apparent relationship between the bitterness of beer and its alcholic content? 

```{r warnings = FALSE}
#Relationship betwen the bitterness of the beer and its alcoholic content, Scaatter plot and discussing 

#Imputed
BeersData %>% ggplot(aes(x = ABV, y = IBU)) + geom_point(color = "light blue") + ggtitle("Beer IBU by ABV")


#Original Values
BeersCopy %>% ggplot(aes(x = ABV, y = IBU)) + geom_point(color = "light green") +
  ggtitle("Beer IBU by ABV")


```

##Key Question Eight
###Investigate teh difference between IPAs and other types of Ales with respect to IBU and ABV

```{r warnings = FALSE}

#Data Set of Just IPA and Ale Beers
AleIPABeers = BeersData %>% filter(str_detect(Style,"IPA") | str_detect(Style,"Ale"))
AleIPABeers = mutate(AleIPABeers, Ale_Type = ifelse(str_detect(AleIPABeers$Style,"IPA"), "IPA", "Ale"))
#Convert the Ale_Type column to a factor
AleIPABeers$Ale_Type <- as.factor(AleIPABeers$Ale_Type)


#Before we go into classifcation lets see the data
AleIPABeers %>% ggplot(aes(x = ABV, y = IBU, color = Ale_Type)) + geom_point() +
  ggtitle("Beer IBU by ABV for Ales and IPAs")



set.seed(9850)
#Testing a 80 30 split to train
TestPercent = .8
BeerIndices = sample(1:dim(AleIPABeers)[1], round(TestPercent * dim(AleIPABeers)[1]))


#Normalize variable Function to a Z score
normalizeList <- function(x) (x - mean(x)) / (sd(x))
AleIPABeers_Norm = AleIPABeers %>% mutate(IBU_Norm = normalizeList(IBU)) %>% mutate(ABV_Norm = normalizeList(ABV))

#Set train and test sets
Train_AleIPA = AleIPABeers_Norm[BeerIndices,]
Test_AleIPA = AleIPABeers_Norm[-BeerIndices,]

# A rule of thum is to set k = to the sqrt(total number of obs.) and preferably use an odd number to help knn break a potential tie
bestK = round(sqrt(dim(AleIPABeers)[1])) #this returns 39 so no need to manually adjust to an odd number

# Generate a prediction from the classification of all the values in the test dataframe
m1 <- knn(Train_AleIPA[,c(9:10)], Test_AleIPA[,c(9:10)], Train_AleIPA$Ale_Type, k=bestK)


#Use the target test data set in the X axis, and put m1 in the Y axis

table(Test_AleIPA$Ale_Type,m1)
confusionMatrix(table(Test_AleIPA$Ale_Type,m1))



```

##Final Exploratory Analysis
###Determining top producer and consumer states with added beer consumption data. 

```{r}
#Knocking off some socks
#Loading the Beer Consumption Data
consumptionData = read.csv("BeerConsumptionData.csv")

stateTranslate = data.frame(Abb = state.abb,Name = state.name)

#Missing DC
DC = data.frame(Abb = "DC", Name = "Dist.of Columbia")
states = rbind(stateTranslate, DC)
states$Name = as.character(states$Name)
states$Abb = as.character(states$Abb)
states = states[order(states$Name),]

consumptionData$StateAbb = states$Abb
consumptionData = consumptionData[order(consumptionData$StateAbb),]


#each beer has combined data.... ??
combinedBeers = merge(BeerWithBreweries, consumptionData, by.x = "State", by.y = "StateAbb")

overall = combinedBeers %>% group_by(State) %>% summarise(Count = n())


#Count of Beers per State
CountofBeers = BeerWithBreweries %>% group_by(State) %>% summarise(Count = n())
CountofBeers$state = CountofBeers$State

plot_usmap(data = CountofBeers, values = "Count", color = "white") + 
  scale_fill_continuous(name = "Unique Beers Produced", low = "#bdffe6", high = "#0f4d36") + 
  theme(legend.position = "right") + ggtitle("Number of Unique Beers Produced by State")




#Mean ABV
ABVMean = BeerWithBreweries %>% group_by(State) %>% summarize(Mean = mean(ABV))
ABVMean$state = ABVMean$State

plot_usmap(data = ABVMean, values = "Mean", color = "white") + 
  scale_fill_continuous(name = "Mean ABV", low = "#bdffe6", high = "#0f4d36") + 
  theme(legend.position = "right") + ggtitle("Mean Alcoholic Beverage Value by State")



#Consumption by State
usmapConsumption = data.frame(state = consumptionData$StateAbb, full = consumptionData$State, perCap = consumptionData$PerCapita.)


plot_usmap(data = usmapConsumption, values = "perCap", color= "white") + 
  scale_fill_continuous(name = "Per Capita Consumption", low = "#d7e2fa" , high = "#122654") + 
  theme(legend.position = "right") + ggtitle("Consumption of Beer in Thousands of Gallons Per Capita by State")

#ConsumptionEthanol 
#Estimate because we dont know these beers are an exhaustive list
usmapConsumption$meanABV = ABVMean$Mean 
usmapConsumption = usmapConsumption %>% mutate(TotalEthanolConsumption = (meanABV * perCap)*1000)

plot_usmap(data = usmapConsumption, values = "TotalEthanolConsumption", color= "white") + 
  scale_fill_continuous(name = "Per CapitaConsumption", low = "#d7e2fa" , high = "#122654") + 
  theme(legend.position = "right") + ggtitle("Average Consumption of Alcohol through Beer in Gallons Per Capita by State")



#Compare Production with Consumption 
ComparedData = data.frame(usmapConsumption, UniqueBeers = CountofBeers$Count)
ComparedData = ComparedData %>% mutate(Producers= UniqueBeers / perCap)

#Producers and Consumer States  
#Light green are states with best opportunities for introducing new beers 
#Darker states are states to focus on changing consumption rates. 
plot_usmap(data = ComparedData, values = "Producers", color= "white") + 
  scale_fill_continuous(name = "Unique Beers by Consumption", low = "#d1ffe7" , high = "#2d4036") + 
  theme(legend.position = "right") + ggtitle("Number of Unique Beers Prodcued by Per Capita Consumption by State")

```


##Conclusion

